{% macro billingRow(row) %}

  {# Status colours #}
  {% set statusColours = { "Accepted": "green", "Pending": "yellow", "Rejected": "red" } %}
  {% set instructionColours = { "Initial": "blue", "Delta": "blue", "Rebill": "blue", "Cancel bill": "blue", "No action": "blue" } %}

  {% set statusColour = statusColours[row.status] or "grey" %}
  {% set instructionColour = instructionColours[row.billingInstruction] or "grey" %}

  {# ADDED: data-instruction attribute so the filter can find it #}
  <tr class="govuk-table__row billing-row"
      data-organisation="{{ row.organisation }}"
      data-org-id="{{ row.organisationId }}"
      data-status="{{ row.status }}"
      data-instruction="{{ row.billingInstruction }}">

    <td class="govuk-table__cell checkbox-select-record">
      <div class="govuk-checkboxes__item">
        {# Note: I added the 'disabled' attribute here too, not just the class #}
        <input 
          class="govuk-checkboxes__input"
          id="select-{{ row.organisationId }}"
          name="selected"
          type="checkbox"
          value="{{ row.organisationId }}"
          {% if row.billingInstruction == 'No action' %}disabled{% endif %}
        >
        <label class="govuk-label govuk-checkboxes__label" for="select-{{ row.organisationId }}">
          <span class="govuk-visually-hidden">Select {{ row.organisation }}</span>
        </label>
      </div>
    </td>

    <td class="govuk-table__cell">{{ row.organisation }}</td>
    <td class="govuk-table__cell">{{ row.organisationId }}</td>
    
    <td class="govuk-table__cell">
      {# This controls the colour of the Instruction column #}
      <strong class="govuk-tag govuk-tag--{{ instructionColour }}">{{ row.billingInstruction }}</strong>
    </td>

    <td class="govuk-table__cell">
      {% if row.displayAmount %}
        £{{ row.displayAmount }}
      {% else %}
        £{{ (row.amount / 100).toLocaleString('en-GB', {minimumFractionDigits: 2}) }}
      {% endif %}
    </td>

    <td class="govuk-table__cell">
      {# LOGIC FIX: Check instruction first. #}
      {# If instruction is "No action", show nothing. Else, check if status exists. #}
      
      {% if row.billingInstruction != 'No action' and row.status %}
        <strong class="govuk-tag govuk-tag--{{ statusColour }}">{{ row.status }}</strong>
      {% endif %}
    </td>
  </tr>
{% endmacro %}