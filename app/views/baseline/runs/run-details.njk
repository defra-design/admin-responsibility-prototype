{% extends "layouts/" + version + ".html" %}

{% block beforeContent %}
  {% set showBackLink = true %}
  {% set showBackLink = true %}
  {% set showAccountLink = true %}
  {% set serviceName = "Dashboard" %}
  {% include version ~ "/_includes/before-content.njk" %}
{% endblock %}

{% block content %}
<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
    {# Include generating banner component (hidden by default unless generating) #}
    {% from "govuk/components/notification-banner/macro.njk" import govukNotificationBanner %}
    {% set bannerHtml %}
      <p class="govuk-notification-banner__heading">Your draft billing file is still generating. You'll be able to continue once it's ready. Please refresh the page.</p>
    {% endset %}
    {% set bannerVisible = false %}
    {% if data.billingFile and data.billingFile.generating %}
      {% set bannerVisible = true %}
    {% endif %}
    {% if bannerVisible %}
      {{ govukNotificationBanner({ titleText: 'Important', type: 'important', html: bannerHtml, id: 'billing-generating-banner' }) }}
    {% endif %}
  </div>
  <div class="govuk-grid-column-two-thirds">
    <form id="actionForm" method="GET" action="run-details">
      <div class="govuk-form-group" style="margin-bottom: 0;">
        <fieldset class="govuk-fieldset" aria-describedby="approval-code-hint">

        {# Show different headers for different run classifications #}
          <span class="govuk-caption-l">
            {% if data.calcRun == "unclassified" %}Unclassified run R16
              {% elif data.calcRun == "initialRun" %}Initial classified run R16
              {% elif data.calcRun == "testRun" %}Test classified run R16
              {% elif data.calcRun == "runError" %}Error incomplete run R16
              {% else %}Regular run R16
            {% endif %}
          </span>
          <h1 class="govuk-heading-l">Calculation run details</h1>
          {% if data.calcRun == "unclassified" %}
            <p class="govuk-body">Download the results file to review the calculation run offline. When you are ready,
            return to classify or delete it.</p>
          {% endif %}

          <table class="govuk-table">
            <tbody class="govuk-table__body">
              <tr class="govuk-table__row">
              <th scope="row" class="govuk-table__header">Financial year</th>
              <td class="govuk-table__cell">2024-25</td>
            </tr>

          {# Only show Classification row if calcRun is a known type #}
          {% if data.calcRun in ["initialRun","testRun","interimRun","finalRecalcRun","finalRun"] %}
            <tr class="govuk-table__row">
              <th scope="row" class="govuk-table__header">Classification</th>
              <td class="govuk-table__cell">
                {% if data.calcRun == "initialRun" %}Initial run{% endif %}
                {% if data.calcRun == "testRun" %}Test run{% endif %}
                {% if data.calcRun == "interimRun" %}Interim run{% endif %}
                {% if data.calcRun == "finalRecalcRun" %}Final recalculation run{% endif %}
                {% if data.calcRun == "finalRun" %}Final run{% endif %}
              </td>
            </tr>
          {% endif %}

            <tr class="govuk-table__row">
              <th scope="row" class="govuk-table__header">Calculation ID</th>
              <td class="govuk-table__cell">251120</td>
            </tr>
              <tr class="govuk-table__row">
                <th scope="row" class="govuk-table__header">Run date and time</th>
                <td class="govuk-table__cell">21 June 2024 at 12:09</td>
              </tr>
              <tr class="govuk-table__row">
                <th scope="row" class="govuk-table__header">Run by</th>
                <td class="govuk-table__cell">Jamie Roberts</td>
              </tr>
            </tbody>
          </table>

          <!----------------------------------
           Download files related to this run
          ----------------------------------->

          <h2 class="govuk-heading-m">Downloads</h2>
          <p class="govuk-body">
              Download files related to this calculation run.
            {% if data.billingConfirmed == true %}
              The billing file sent to the FSS must reflect the latest confirmed billing instructions.
            {% endif %}
          </p>
            <div class="govuk-button-group">
              <a id="download-results" href="#" class="govuk-button govuk-button--secondary" role="button">
                Results file
              </a>
              <p id="status-results" class="govuk-body" style="display: none">
                <strong>Downloading...</strong> Please wait while we prepare your file.
              </p>
              {% if data.billingConfirmed == true %}
                <a id="download-draft" href="#" class="govuk-button govuk-button--secondary" role="button" disabled="" aria-disabled="true">
                  Draft billing file
                </a>
                <div class="govuk-button-group ">
                  <a id="download-draft" href="#" class="govuk-button govuk-button--secondary" role="button" disabled="" aria-disabled="true">
                    Generate new draft billing file
                  </a>
                  <p class="govuk-body">This file will reflect the latest confirmed billing instructions.</p>
                  <p id="status-draft" class="govuk-body" style="display: none">
                    <strong>Downloading...</strong> Please wait while we prepare your file.
                  </p>
                </div>
              {% endif %}
            </div>
            

          <p id="download-status" class="govuk-body govuk-!-margin-top-3" style="display: none;">
            <strong>Downloading...</strong> Please wait while we prepare your file.
          </p>
          <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
          

          <!-- Remove Classification start if it has already been classified (todo) -->
          {% if data.calcRun == "initialRun" %}
              <h2 class="govuk-heading-m">Remove this run's classification</h2>
              <p class="govuk-body">Mark this run as a test or delete it to remove its classification.</p>
               <!-- if billing has been confirmed and billing file is being generated - then disable this button otherwise activaate-->
              <div class="govuk-button-group">
                <a href="classify-run-remove" class="govuk-button govuk-button--secondary" style="display: inline" role="button" disabled="" aria-disabled="true">Remove classification</a>
              </div>
              <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
          {% endif %}

          <!-- Amend billing instructions if billing confirmed  - disable if billing file is being generated-->
          {% if data.billingConfirmed == true %}
              <h2 class="govuk-heading-m">Amend billing instructions</h2>
              <p class="govuk-body">Review or change the billing instructions. If the instructions have changed, you'll need to generate a new draft billing file before you can continue.</p>
              <div class="govuk-button-group">
                <a href="classify-run-remove" class="govuk-button govuk-button--secondary" style="display: inline;">Amend billing instructions</a>
              </div>
              <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
          {% endif %}

          {% if data.calcRun == "initialRun" %}
            <h2 class="govuk-heading-m">Next step</h2>
            
            {% if data.billingConfirmed == true %}
              <p class="govuk-body">Confirm that you want to send the billing file to the FSS.</p>
              <div class="govuk-warning-text">
                  <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
                  <strong class="govuk-warning-text__text">
                    <span class="govuk-visually-hidden">Warning</span>
                    Once sent, you will not be able to amend the billing file.
                  </strong>
                </div>
              {% else%}
              <p class="govuk-body">Review and confirm the billing instructions from the results file.</p>
            {% endif %}
          {% endif %}
            <div class="govuk-button-group"><a href="../billing/confirm-billing-instructions" class="govuk-button show-continue" style="display: inline;">
                Continue
              </a>
              <a class="govuk-link" href="../paycal-dashboard">Return to dashboard</a>
            </div>
          

          <!-- if test run show delete run section -->
          {% if data.calcRun == "testRun" %}

            <h2 class="govuk-heading-m">Delete this run</h2>
            <p class="govuk-body">Remove this calculation if you no longer need it.</p>
            <div class="govuk-button-group"><a href="delete-run" class="govuk-button govuk-button--secondary" style="display: inline;">
                Delete run
              </a>

              <a class="govuk-link" href="../paycal-dashboard">Return to dashboard</a>
            </div>
            {% elif data.calcRun !== "initialRun" %}
              
            {#{% if data.calcRun in ["unclassified","interimRun","finalRecalcRun","finalRun"] %}#}
            <h2 class="govuk-heading-m">What do you want to do next?</h2>
            <p class="govuk-body">If you are unsure about how to classify this run, speak to your finance team or a
                senior team member before continuing.</p>
            <div class="govuk-radios" data-module="govuk-radios">
              <div class="govuk-radios__item">
                <input class="govuk-radios__input" id="classifyRun" name="runAction" type="radio" value="classify">
                <label class="govuk-label govuk-radios__label" style="padding:0px 15px 11px 10px" for="classifyRun">
                  <strong>Classify</strong><br>
                  <p class="govuk-body-s" style="margin-bottom: 0;">Choose a classification to process this
                    calculation run.</p>
                </label>
              </div>

              <div class="govuk-radios__item">
                <input class="govuk-radios__input" id="deleteRun" name="runAction" type="radio" value="delete">
                <label class="govuk-label govuk-radios__label" style="padding:0px 15px 11px 10px" for="deleteRun">
                  <strong>Delete</strong><br>
                  <p class="govuk-body-s" style="margin-bottom: 30;">Remove this calculation run if it’s no longer
                    needed.</p>
                </label>
              </div>
            </div>
            <!-- if billing instructions if billing confirmed  - disable if billing file is being generated
            otherwise continue to action-->
            <div class="govuk-button-group">
              <button type="submit" class="govuk-button" data-module="govuk-button">
                Continue
              </button>
              <a class="govuk-link" href="../paycal-dashboard">Return to the dashboard</a>
            </div>
          {% endif %}
        </fieldset>
      </div>
    </form>
  </div>
</div>

<script>
  document.getElementById("actionForm").addEventListener("submit", function (e) {
    const classify = document.getElementById("classifyRun").checked;
    const deleteRun = document.getElementById("deleteRun").checked;

    if (classify) {
      this.action = "classify-run";
    } else if (deleteRun) {
      this.action = "delete-run";
    } else {
      e.preventDefault();
      alert("Please select an option before continuing.");
    }
  });
</script>

<script>
  document.getElementById('download-button').addEventListener('click', function (event) {
    event.preventDefault(); // Prevent actual navigation for simulation

    const statusText = document.getElementById('download-status');
    statusText.style.display = 'block';

    // Simulate download delay (e.g. 2 seconds)
    setTimeout(() => {
      statusText.innerHTML = '<strong>✔ Download complete.</strong> Your file has been saved.';

      // If you'd like to trigger an actual download, uncomment below:
      // window.location.href = '/downloads/results-file.csv'; 
    }, 2000);
  });
</script>

{% endblock %}

