{% extends "layouts/" + version + ".html" %}

{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "govuk/components/tag/macro.njk" import govukTag %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/warning-text/macro.njk" import govukWarningText %}

{% block beforeContent %}
  {% set showBackLink = false %}
  {% set showAccountLink = true %}
  
  {% include version ~ "/_includes/before-content.njk" %}
{% endblock %}

{% set pageName="pEPR Oversight Dashboard" %}

{% block content %}

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <span class="govuk-caption-l">Scheme Administrator</span>
    <h1 class="govuk-heading-l">{{ pageName }}</h1>
  </div>
</div>

<div class="govuk-grid-row">
  {# LEFT 2/3: STRATEGIC INSIGHTS & ANALYTICS #}
  <div class="govuk-grid-column-two-thirds">
    
    {# KPI SUMMARY SECTION #}
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-one-half">
        <div class="dashboard-kpi-block">
          <span class="govuk-body-s govuk-!-margin-bottom-1">2024 POM Disbursement Fund</span>
          <span class="govuk-heading-l govuk-!-margin-bottom-0">£1.4bn</span>
          <p class="govuk-body-s govuk-!-margin-top-2">
            {{ govukTag({ text: "Current Status: Disbursing", classes: "govuk-tag--green" }) }}
          </p>
        </div>
      </div>
      <div class="govuk-grid-column-one-half">
        {# Link updated to point to Integrity Risks section #}
        <a href="#integrity-risks" class="dashboard-kpi-link">
          <div class="dashboard-kpi-block dashboard-kpi-block--live">
            <div class="live-status-container">
              <span class="status-pulse-dot"></span>
              <span class="govuk-body-s govuk-!-font-weight-bold">RE Ex Monthly Feed</span>
            </div>
            <span class="govuk-heading-l govuk-!-margin-bottom-0">Connected</span>
            <p class="govuk-body-s govuk-!-margin-top-2">Check Integrity Status &darr;</p>
          </div>
        </a>
      </div>
    </div>

    {# RAM PORTFOLIO ANALYSIS #}
    <div class="govuk-!-margin-top-8">
      <h2 class="govuk-heading-m">Actual Reported RAM Portfolio (2024/25 Data)</h2>
      <p class="govuk-body">Verified recyclability ratings based on large producer RPD submissions.</p>
      
      {# Increased height to 80px as requested #}
      <div class="gds-portfolio-stack">
        <div class="stack-part stack-part--green govuk-heading-s" style="width: 58%;">58% G</div>
        <div class="stack-part stack-part--amber govuk-heading-s" style="width: 18%;">18% A</div>
        <div class="stack-part stack-part--red govuk-heading-s" style="width: 24%;">24% R</div>
      </div>
      
      <div class="govuk-grid-row govuk-!-margin-top-4">
        <div class="govuk-grid-column-one-third">
          <p class="govuk-body-s govuk-!-margin-bottom-1"><strong>£812m</strong></p>
          <span class="govuk-hint govuk-!-font-size-14">Green Tier (Incentivised)</span>
        </div>
        <div class="govuk-grid-column-one-third">
          <p class="govuk-body-s govuk-!-margin-bottom-1"><strong>£252m</strong></p>
          <span class="govuk-hint govuk-!-font-size-14">Amber Tier (Base Rate)</span>
        </div>
        <div class="govuk-grid-column-one-third">
          <p class="govuk-body-s govuk-!-margin-bottom-1"><strong>£336m</strong></p>
          <span class="govuk-hint govuk-!-font-size-14">Red Tier (Penalised)</span>
        </div>
      </div>
    </div>

    {# DATA INTEGRITY ISSUES SECTION #}
    <div id="integrity-risks" class="govuk-!-margin-top-9 integrity-section">
      <h2 class="govuk-heading-m">Data Integrity & Risks</h2>
      <p class="govuk-body">Active issues identified within the RPD portal and RE Ex feeds requiring manual intervention.</p>

      {{ govukWarningText({
        text: "3,200 tonnes of Wood packaging currently lack verified RAM ratings. Failure to resolve will default these to 'Red' status by the H2 deadline.",
        iconFallbackText: "Warning"
      }) }}

      <div class="govuk-grid-row">
        <div class="govuk-grid-column-one-half">
          <div class="integrity-card">
            <h3 class="govuk-heading-s govuk-!-margin-bottom-1">Submission Anomalies</h3>
            <span class="govuk-heading-m govuk-!-margin-bottom-1">42</span>
            <p class="govuk-body-s">Large producers flagged for material weight variance > 15% YoY.</p>
          </div>
        </div>
        <div class="govuk-grid-column-one-half">
          <div class="integrity-card">
            <h3 class="govuk-heading-s govuk-!-margin-bottom-1">Unmatched Exports</h3>
            <span class="govuk-heading-m govuk-!-margin-bottom-1">12,400t</span>
            <p class="govuk-body-s">Export tonnages reported via RE Ex not yet paired with producer POM data.</p>
          </div>
        </div>
      </div>

      {{ govukTable({
        caption: "Priority Reconciliation Tasks",
        captionClasses: "govuk-table__caption--s",
        head: [
          { text: "Issue Category" },
          { text: "Impact", format: "numeric" },
          { text: "Owner" },
          { text: "Urgency" }
        ],
        rows: [
          [
            { text: "Incomplete RAM scores" },
            { text: "£4.2m", format: "numeric" },
            { text: "Compliance Team" },
            { html: govukTag({ text: "High", classes: "govuk-tag--red" }) }
          ],
          [
            { text: "Weight Discrepancy (Plastic)" },
            { text: "£1.8m", format: "numeric" },
            { text: "Data Analyst" },
            { html: govukTag({ text: "Medium", classes: "govuk-tag--yellow" }) }
          ],
          [
            { text: "Missing B2C POM Data" },
            { text: "N/A", format: "numeric" },
            { text: "Producer Support" },
            { html: govukTag({ text: "Low", classes: "govuk-tag--blue" }) }
          ]
        ]
      }) }}
    </div>

    {# RE EX LIVE MONITORING SECTION #}
    <div id="re-ex-operations" class="govuk-!-margin-top-9 re-ex-section">
      <h2 class="govuk-heading-m">RE Ex Live Operations</h2>
      <p class="govuk-body">Monthly export data ingestion and verification status for the current reporting window.</p>

      <div class="govuk-grid-row">
        <div class="govuk-grid-column-one-third">
          <div class="re-ex-metric">
            <span class="govuk-caption-m">Throughput</span>
            <span class="govuk-heading-m govuk-!-margin-bottom-0">842,000t</span>
            <p class="govuk-body-s govuk-!-margin-top-1 govuk-!-margin-bottom-0">+2.4% vs prev</p>
          </div>
        </div>
        <div class="govuk-grid-column-one-third">
          <div class="re-ex-metric">
            <span class="govuk-caption-m">Data Integrity</span>
            <span class="govuk-heading-m govuk-!-margin-bottom-0">99.2%</span>
            <p class="govuk-body-s govuk-!-margin-top-1 govuk-!-margin-bottom-0">6 alerts pending</p>
          </div>
        </div>
        <div class="govuk-grid-column-one-third">
          <div class="re-ex-metric">
            <span class="govuk-caption-m">Reporting Lag</span>
            <span class="govuk-heading-m govuk-!-margin-bottom-0">0.8 days</span>
            <p class="govuk-body-s govuk-!-margin-top-1 govuk-!-margin-bottom-0">GDS Optimal</p>
          </div>
        </div>
      </div>

      {{ govukTable({
        caption: "Recent RE Ex Batch Updates",
        captionClasses: "govuk-table__caption--s",
        firstCellIsHeader: false,
        head: [
          { text: "Batch ID" },
          { text: "Provider" },
          { text: "Material" },
          { text: "Status" }
        ],
        rows: [
          [
            { text: "RX-4492-A" },
            { text: "Env-Export Ltd" },
            { text: "Plastic (Mixed)" },
            { html: govukTag({ text: "Verified", classes: "govuk-tag--green govuk-!-font-size-14" }) }
          ],
          [
            { text: "RX-4493-B" },
            { text: "Global Recyclers" },
            { text: "Fibre-based" },
            { html: govukTag({ text: "In Progress", classes: "govuk-tag--yellow govuk-!-font-size-14" }) }
          ],
          [
            { text: "RX-4494-C" },
            { text: "NorthSea Waste" },
            { text: "Aluminium" },
            { html: govukTag({ text: "Flagged", classes: "govuk-tag--red govuk-!-font-size-14" }) }
          ]
        ]
      }) }}

      {{ govukDetails({
        summaryText: "View RE Ex data extraction methodology",
        html: '<p class="govuk-body-s">RE Ex data is pulled automatically from the centralized Regulator Export API on the 15th of every month. PackUK Scheme Admin validates against H1 POM data.</p>'
      }) }}
    </div>

    {# MODULATION IMPACT TABLE #}
    <div class="govuk-!-margin-top-9">
      <h2 class="govuk-heading-m">Modulation Variance (Year 2 Estimates)</h2>
      <p class="govuk-body">Executive comparison of Green vs Red fees per tonne by primary material.</p>

      {{ govukTable({
        firstCellIsHeader: true,
        head: [
          { text: "Material" },
          { text: "Green Fee", format: "numeric" },
          { text: "Red Fee", format: "numeric" },
          { text: "Variance", format: "numeric" }
        ],
        rows: [
          [
            { text: "Plastic" },
            { text: "£415", format: "numeric" },
            { text: "£545", format: "numeric" },
            { text: "£130", format: "numeric" }
          ],
          [
            { text: "Fibre-based composite" },
            { text: "£475", format: "numeric" },
            { text: "£630", format: "numeric" },
            { text: "£155", format: "numeric" }
          ],
          [
            { text: "Aluminium" },
            { text: "£245", format: "numeric" },
            { text: "£325", format: "numeric" },
            { text: "£80", format: "numeric" }
          ],
          [
            { text: "Paper and card" },
            { text: "£190", format: "numeric" },
            { text: "£250", format: "numeric" },
            { text: "£60", format: "numeric" }
          ]
        ]
      }) }}
    </div>

    <div class="policy-alert-card govuk-!-margin-top-6">
      <h3 class="govuk-heading-s govuk-!-margin-bottom-1">Policy Insight</h3>
      <p class="govuk-body-s">The £155 delta in Fibre-based composites is driving significant sector-wide redesign. Monitoring of 1 October data submissions is required for evidence of material switching.</p>
    </div>

  </div>

  {# RIGHT 1/3: OFFICIAL MOJ TIMELINE PATTERN #}
  <div class="govuk-grid-column-one-third">
    <aside class="dashboard-sidebar-timeline">
      <h2 class="govuk-heading-m">Eco-modulation Timeline</h2>
      
      <div class="moj-timeline">

        <div class="moj-timeline__item">
          <div class="moj-timeline__header">
            <h2 class="moj-timeline__title">Assessment Year Start</h2>
            <p class="moj-timeline__byline">by PackUK</p>
          </div>
          <p class="moj-timeline__date">
            <time datetime="2025-01">January 2025</time>
          </p>
        </div>

        <div class="moj-timeline__item">
          <div class="moj-timeline__header">
            <h2 class="moj-timeline__title">RAM v1.1 Published</h2>
            <p class="moj-timeline__byline">by PackUK</p>
          </div>
          <p class="moj-timeline__date">
            <time datetime="2025-04">April 2025</time>
          </p>
        </div>

        <div class="moj-timeline__item">
          <div class="moj-timeline__header">
            <h2 class="moj-timeline__title">Data Submission H1</h2>
            <p class="moj-timeline__byline">by PackUK</p>
          </div>
          <p class="moj-timeline__date">
            <time datetime="2025-10-01">1 October 2025</time>
          </p>
        </div>

        <div class="moj-timeline__item current-stage-highlight">
          <div class="moj-timeline__item-content">
            <div class="moj-timeline__header">
              <h2 class="moj-timeline__title">
                Illustrative Fees Y2
              </h2>
              <p class="moj-timeline__byline">by PackUK</p>
            </div>
            <p class="moj-timeline__date">
              <time datetime="2025-12">December 2025</time>
            </p>
            <div class="moj-timeline__description">
              <p class="govuk-body-s">Publication of Year 2 fees to aid producer planning.</p>
              {{ govukDetails({
                summaryText: "Quick links",
                html: '<p class="govuk-body-s">Access <a href="#" class="govuk-link">Fees Guidance</a></p>',
                classes: "govuk-!-margin-bottom-0"
              }) }}
            </div>
          </div>
        </div>

        <div class="moj-timeline__item">
          <div class="moj-timeline__header">
            <h2 class="moj-timeline__title">RAM Review</h2>
            <p class="moj-timeline__byline">by TAC</p>
          </div>
          <p class="moj-timeline__date">
            <time datetime="2026-Q1">Quarter 1 2026</time>
          </p>
        </div>

        <div class="moj-timeline__item">
          <div class="moj-timeline__header">
            <h2 class="moj-timeline__title">Submission H2</h2>
            <p class="moj-timeline__byline">by PackUK</p>
          </div>
          <p class="moj-timeline__date">
            <time datetime="2026-04-01">1 April 2026</time>
          </p>
        </div>

        <div class="moj-timeline__item">
          <div class="moj-timeline__header">
            <h2 class="moj-timeline__title">Liability Notices</h2>
            <p class="moj-timeline__byline">by PackUK</p>
          </div>
          <p class="moj-timeline__date">
            <time datetime="2026-10">October 2026</time>
          </p>
        </div>

      </div>
    </aside>
  </div>
</div>

<style>
  /* Executive Dashboard Styling */
  .dashboard-kpi-block {
    background-color: #ffffff;
    border-top: 5px solid #1d70b8;
    padding: 20px;
    box-shadow: 0 2px 0 rgba(0,0,0,0.05);
    height: 100%;
    transition: background-color 0.2s ease;
  }

  .dashboard-kpi-block:hover {
    background-color: #f3f2f1;
  }

  .dashboard-kpi-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .dashboard-kpi-block--live {
    border-top-color: #00703c;
  }

  .live-status-container {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    color: #00703c;
  }

  /* Integrity Section Styling */
  .integrity-section {
    border: 1px solid #b1b4b6;
    padding: 20px;
    background-color: #ffffff;
  }

  .integrity-card {
    background-color: #f8f8f8;
    padding: 15px;
    border-top: 4px solid #d4351c;
    margin-bottom: 20px;
  }

  /* RE EX Section Styling */
  .re-ex-section {
    border: 1px solid #b1b4b6;
    padding: 20px;
    background-color: #ffffff;
  }

  .re-ex-metric {
    border-bottom: 4px solid #1d70b8;
    background-color: #f8f8f8;
    padding: 15px;
    margin-bottom: 20px;
  }

  /* Portfolio Stack Visualization */
  .gds-portfolio-stack {
    display: flex;
    width: 100%;
    height: 80px;
    margin-top: 15px;
    color: #ffffff;
  }

  .stack-part {
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    white-space: nowrap;
    color: #ffffff;
  }

  .stack-part--green { background-color: #00703c; }
  .stack-part--amber { background-color: #f47738; }
  .stack-part--red { background-color: #d4351c; }

  /* Strategic/Policy Box */
  .policy-alert-card {
    background-color: #f3f2f1;
    border-left: 10px solid #1d70b8;
    padding: 20px;
  }

  /* Sidebar Timeline Highlight */
  .moj-timeline__item.current-stage-highlight {
    padding: 0 !important;
    margin: 0 !important;
    border-left: none !important;
    background: none !important;
  }

  .moj-timeline__item-content {
    background-color: #eeeeee;
    padding: 15px;
    margin-top: -12px;
    border-left: 4px solid #1d70b8;
    margin-left: 1px;
    padding-left: 30px;
    margin-bottom: 20px;
    padding-bottom: 20px;
}

  /* Status Pulse */
  .status-pulse-dot {
    height: 12px;
    width: 12px;
    background-color: #00703c;
    border-radius: 50%;
    margin-right: 10px;
    animation: pulse-green-glow 2s infinite;
  }

  @keyframes pulse-green-glow {
    0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(0, 112, 60, 0.7); }
    70% { transform: scale(1.1); box-shadow: 0 0 0 8px rgba(0, 112, 60, 0); }
    100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(0, 112, 60, 0); }
  }

  /* MOJ Timeline Override */
  .moj-timeline__title { font-size: 1.1875rem; margin-bottom: 5px; }
  .moj-timeline__byline { font-size: 1rem; color: #505a5f; margin-bottom: 5px; }
  .moj-timeline__date { font-size: 1rem; color: #505a5f; margin-bottom: 15px; }
  
  .moj-timeline__item:before {
    z-index: 1;
  }
</style>

{% endblock %}